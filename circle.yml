general:
    branches:
        ignore:
            - gh-pages

    artifacts:
        - build

machine:
    environment:
        PHP_VERSIONS: 5.5.21, 5.6.14, 7.0.0RC7
    php:
        version: 5.6.14
    post:
        - IFS=', ' read -r -a PHP_VERSIONS <<< "$PHP_VERSIONS"; echo "export PHP_VERSIONS=(${PHP_VERSIONS[@]})" >> .circlerc

dependencies:
    pre:
        - nvm alias default node
        - npm config set progress false
        - npm install -g npm
        - sudo composer self-update

    override:
        - npm install
        - for PHP_VERSION in "${PHP_VERSIONS[@]}"; do phpenv global "$PHP_VERSION"; composer install --prefer-source --no-interaction; rm -rf composer.lock; mv vendor "/tmp/vendor.$PHP_VERSION"; done

    cache_directories:
        - node_modules
        - "~/.composer/cache/files"

test:
    pre:
        - for PHP_VERSION in "${PHP_VERSIONS[@]}"; do phpenv global "$PHP_VERSION"; sed -i 's/^;//' "$HOME/.phpenv/versions/$(phpenv global)/etc/conf.d/xdebug.ini"; done

    override:
        - npm run-script lint-ci
        - for PHP_VERSION in "${PHP_VERSIONS[@]}"; do rm -rf "build"; phpenv global "$PHP_VERSION"; ln -snf "/tmp/vendor.$PHP_VERSION" vendor; composer run-script test-ci; done

    post:
        - vendor/bin/coveralls --verbose
